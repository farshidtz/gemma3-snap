name: Testflinger tests

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      channel:
        description: 'Snap store channel'
        required: true
        type: string

jobs:
  test:
    name: Test
    strategy:
      # max-parallel: Don't use this as the self-hosted Github runners team wants to see and fix scaling issues.
      # These limits also do not apply to dynamic instances, like the standard self-hosted runners.
      fail-fast: false
      matrix:
        jobs:
          - job_queue: docker-nvidia
            expected_engine: nvidia-gpu-amd64
            expected_tps: 2
            nvidia_driver_version: "570"
          - job_queue: 202409-35842 # ProLiant DL360 Gen9 with Intel(R) Xeon(R) CPU E5-2690 v3 @ 2.60GHz
            select_engine: intel-cpu
            expected_tps: 8 # samples: 8.51

    runs-on: self-hosted-linux-amd64-jammy-private-endpoint-medium

    env:
      TEST_DIR: tests/testflinger

    steps:
      - name: Show configuration
        run: |
          echo ::notice::Channel: ${{ inputs.channel }}, \
          Queue: ${{ matrix.jobs.job_queue }}, \
          Engine: ${{ matrix.jobs.expected_engine }}, \
          TPS: ${{ matrix.jobs.expected_tps }}

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          repository: canonical/inference-snaps-dev

      - name: Add config to testflinger job
        env:
          SNAP_NAME: gemma3
          SNAP_CHANNEL: ${{ inputs.channel }}
          JOB_QUEUE: ${{ matrix.jobs.job_queue }}
          EXPECTED_ENGINE: ${{ matrix.jobs.expected_engine }}
          EXPECTED_TPS: ${{ matrix.jobs.expected_tps }}
          INSTALL_NVIDIA_DRIVER_VERSION: ${{ matrix.jobs.nvidia_driver_version }}
          SELECT_ENGINE: ${{ matrix.jobs.select_engine }}

        run: |
          envsubst \
            < $TEST_DIR/testflinger.yaml \
            > $TEST_DIR/testflinger.temp.yaml
          mv $TEST_DIR/testflinger.temp.yaml $TEST_DIR/testflinger.yaml

      - name: Print testflinger job
        run: |
          cat ${{ env.TEST_DIR }}/testflinger.yaml

      - name: Run testflinger job
        uses: canonical/testflinger/.github/actions/submit@main
        with:
          poll: true
          job-path: ${{ env.TEST_DIR }}/testflinger.yaml
